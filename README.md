# CDK Aspects Override

This is an example project for demonstrating the use of CDK Aspects to override infrastructure resource properties using CDK Aspects. This pattern demonstrates how to customize the default names of roles created by CDK constructs. Customizing role names is often required by different users or customers who have constraints based on role names. For example, setting a permission boundary to allow the creation of roles with a certain prefix. In such scenarios, the default role names created by CDK constructs do not meet the required naming conventions and hence need to be changed. This pattern addresses this need by providing a way to specify custom role names, ensuring compliance with organizational policies and constraints.

## Prerequisites

* Prepare your development environment by following the instructions in the [AWS CDK Developer Guide](https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-typescript.html).
* Bootstrap your AWS account by following the instructions in the [Bootstrap your environment for use with the AWS CDK](https://docs.aws.amazon.com/cdk/v2/guide/bootstrapping-env.html).

## Setting up the project

* Clone this repository locally and navigate to the project directory.
* Run `npm install` to install the project dependencies.

## Project structure

This project contain two CDK Apps to demonstrate the use of CDK Aspects to override infrastructure resource properties. The default app is in the `bin/app-without-aspects.ts` file and the app with aspects is in the `bin/app-with-aspects.ts` file.

In order to demonstrate CDK managed resources, the project creates some example Lambda functions without explicit Roles attached to them. This will cause CDK to create new Roles for the Lambda function with CDK generated names.

The Lambda function and example stacks are defined in `lib/example-stack.ts`.

This project will show how to use CDK Aspects to override the Role name for the Lambda functions to align to a specific naming convention.

## Project walkthrough

### Deploy example stacks without Aspects

* Run `cdk ls` to list the stacks in the default app without any overrides.
```
> cdk ls
ExampleStack1WithoutAspects (example-stack1-without-aspects)
ExampleStack2WithoutAspects (example-stack2-without-aspects)
```

* Run `cdk deploy --all` to deploy the example stacks to your account.

* The output of the deploy command shows the Role names generated by CDK for the Lambda functions.
```
Outputs:
ExampleStack1WithoutAspects.Function1RoleName = example-stack1-without-as-Function1LambdaFunctionSe-y7FYTY6FXJXA
ExampleStack1WithoutAspects.Function2RoleName = example-stack1-without-as-Function2LambdaFunctionSe-dDZV4rkWqWnI

..

Outputs:
ExampleStack2WithoutAspects.Function3RoleName = example-stack2-without-as-Function3LambdaFunctionSe-ygMv49iTyMq0
```

### Deploy example stacks with Aspects

* Now we apply a CDK Aspect to enforce a Role name convention by adding a prefix to all IAM Roles deployed in the CDK project. The Aspect is defined in the `lib/aspects.ts` file. The Aspect uses an [escape hatch](https://docs.aws.amazon.com/cdk/v2/guide/cfn_layer.html) to override the Role name by adding a prefix. The aspect is applied to the stacks in the `bin/app-with-aspects.ts` file. An example Role name prefix is defined in this file as `dev-unicorn`.

* List the stacks in the app with the aspects applied: `cdk --app 'npx ts-node bin/app-with-aspects.ts' ls`

```
> cdk --app 'npx ts-node bin/app-with-aspects.ts' ls   

ExampleStack1WithAspects (example-stack1-with-aspects)
ExampleStack2WithAspects (example-stack2-with-aspects)
```

* Deploy the stacks with the aspects applied: `cdk --app 'npx ts-node bin/app-with-aspects.ts' deploy --all`

* The output of the deploy command shows the Role names generated by CDK for the Lambda functions with the prefix applied by the Aspect.
```
Outputs:
ExampleStack1WithAspects.Function1RoleName = dev-unicorn-Function1LambdaFunctionServiceRole783660DC
ExampleStack1WithAspects.Function2RoleName = dev-unicorn-Function2LambdaFunctionServiceRole2C391181

..

Outputs:
ExampleStack2WithAspects.Function3RoleName = dev-unicorn-Function3LambdaFunctionServiceRole4CAA721C
```

## Cleanup

* Run `cdk destroy --all -f && cdk --app 'npx ts-node bin/app-with-aspects.ts' destroy --all -f` to delete all the stacks in the project.